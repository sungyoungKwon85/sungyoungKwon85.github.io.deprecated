# book-microservice-pattern
`마이크로서비스 패턴, 길벗` 도서 요약 정리입니다.   
`FTGO`라는 `음식배달` 서비스를 예제로 합니다.    
기존에는 `WAR`파일로 구성된 `모놀리스`로 개발되었으나 서비스가 커지면서 많은 문제가 발생합니다.

#

## 6. 이벤트 소싱

도메인 이벤트를 발행하는 여러 DDD 애그리거트로 비즈니스 로직을 구성.    

여러 서비스에 걸쳐 데이터 일관성을 유지하는 코레오그래피 사가도 이벤트로 구현.

효율적인 쿼리를 지원하는 CQRS 뷰(7장)라는 레플리카도 활용. 



그러나 혹시라도 이벤트 발행 로직이 오류를 양산하는 공장이 될 수 있다. 

이벤트 발행 로직이 비즈니스 로직에 추가되면 실수로 이벤트 발행 로직을 빠뜨려도 비즈니스 로직은 그냥 흘러갈 것이다. 



이벤트 중심으로 비즈니스 로직을 작성하고 도메인 객체를 저장하는 이벤트 소싱 기법

이벤트 소싱을 잘 활용하면 애그리거트가 생성/수정될 때마다 무조건 이벤트를 발행해서 프로그래밍 오류를 제거할 수 있다



---

이벤트 소싱은 비즈니스 로지긍ㄹ 구성하고 애그리거트를 저장하는 또 다른 방법.

애그리거트를 일련의 이벤트 형태로 저장. 

이벤트는 각 애그리거트의 상태 변화.

애그리거트 이력이 보존되므로 감사/통제 용도로 좋고, 도메인 이벤트를 확실하게 발행할 수 있어서 좋음. 

단점? 로직 작성 방법이 특이하여 학습시간이 필요하며 이벤트 저장소 쿼리가 쉽지 않아 CQRS 패턴을 적용해야 함.



---

#### 기존 영속화의 문제점

- 객체-관계 impedance mismatch
- 애그리거트 이력이 없음
- 감사 로깅을 구현하기 어려움
- 이벤트 발행 로직이 비즈니스 로직에 추가됨



---

#### 이벤트 소싱 개요

이벤트 소싱은 이벤트를 위주로 비즈니스 로직을 구현, 애그리거트를 DB에 일련의 이벤트로 저장하는 기법.

이벤트는 애그리거트의 상태변화. 

애그리거트의 비즈니스 로직은 이벤트를 생산/소비 하는 요건 중심으로 구성된다. 



---

Order 애그리거트를 이벤트 소싱으로 저장한다면

Order를 ORDER 테이블에 로우 단위로 저장하는게 아니라

Order 애그리거트를 EVENTS 테이블의 여러 로우로 저장한다. 

각 로우가 "주문 생성됨", "주문 승인됨", "주문 배달됨" 등의 도메인 이벤트이다. 



1. 애그리거트 생성/수정 시 애플리케이션은 애그리거트가 발생시킨 이벤트를 EVENTS 테이블에 삽입

2. 애그리거트 로드

3. 기본 생성자를 호출하여 애그리거트 인스턴스를 생성

4. 이벤트를 하나씩 순회하면 apply()를 호출

```java
// Eventuate Client 프레임워크에도 위 로직처럼 이런 코드가 있음
Class aggregateClass = ...;
Aggregate aggregate = aggregateClass.newInstance();
for (Event : event) {
  aggregate = aggregate.applyEvent(event);
}
...
```

함수형 프로그래밍의 fold 또는 reduce 작업이랑 흡사하다. 

(사실 JPA 등의 ORM 프레임워크가 엔티티를 로드하는 방법도 이와 비슷함)



---

